<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色對弈遊戲</title>
    <style>
        /* 保留原始 CSS，僅添加少量調整 */
        .character-card {
            position: relative;
        }
        .character-card .status {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.8em;
            color: #666;
        }
        .battle-log p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>角色對弈遊戲</h1>
            <p>選擇角色、佈置陣型，展開戰略對決！</p>
        </header>
        
        <div class="phase-indicator" id="phaseIndicator">
            遊戲階段：禁用階段 (Ban Phase)
        </div>
        
        <div class="player-info">
            <div class="player-panel player-a">
                <h3>玩家 A</h3>
                <div id="playerA-banned">禁用角色：尚未選擇</div>
                <div id="playerA-characters" class="player-characters"></div>
            </div>
            <div class="player-panel player-b">
                <h3>玩家 B</h3>
                <div id="playerB-banned">禁用角色：尚未選擇</div>
                <div id="playerB-characters" class="player-characters"></div>
            </div>
        </div>
        
        <div class="game-area">
            <div class="control-panel">
                <h2>角色選擇</h2>
                <div class="character-selection" id="characterSelection"></div>
                <div class="action-buttons">
                    <button id="banBtn">禁用選中角色</button>
                    <button id="pickBtn">選擇角色</button>
                    <button id="placeBtn">佈置角色</button>
                    <button id="battleBtn">執行戰鬥</button>
                    <button id="resetBtn">重置遊戲</button>
                </div>
            </div>
            <div class="game-board">
                <h2>遊戲棋盤</h2>
                <div class="board-grid" id="gameBoard"></div>
                <div class="battle-log" id="battleLog">
                    <p>遊戲開始，請進行禁用階段...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 角色對弈遊戲原型 (保持不變)
        class Game {
            constructor() {
                this.characters = [];
                this.initializeCharacters();
                this.playerA = {
                    name: "玩家A",
                    selectedCharacters: [],
                    bannedCharacter: null,
                    placedCharacters: new Array(8).fill().map(() => new Array(8).fill(null))
                };
                this.playerB = {
                    name: "玩家B",
                    selectedCharacters: [],
                    bannedCharacter: null,
                    placedCharacters: new Array(8).fill().map(() => new Array(8).fill(null))
                };
                this.currentPhase = "ban";
                this.currentTurn = "playerA";
                this.gameBoard = new Array(8).fill().map(() => new Array(8).fill(null));
                this.battleTurn = 0;
                this.selectedCharacter = null;
            }

            initializeCharacters() {
                this.characters = [
                    // 保留原始 12 個角色定義...
                    {
                        id: 1,
                        name: "Selina",
                        title: "無差鱉攻擊",
                        hp: 800,
                        attack: 120,
                        position: "mid",
                        skill: (self, allCharacters) => {
                            const enemies = allCharacters.filter(c => c.owner !== self.owner && c.hp > 0);
                            if (enemies.length > 0) {
                                const target = enemies[Math.floor(Math.random() * enemies.length)];
                                target.hp -= self.attack;
                                return `${self.name} 使用無差鱉攻擊，隨機攻擊 ${target.name}！`;
                            }
                            return `${self.name} 使用無差鱉攻擊，但沒有目標！`;
                        }
                    },
                    // 其他角色定義省略，保持不變
                    {
                        id: 12,
                        name: "Emily",
                        title: "我們都是臭婊",
                        hp: 730,
                        attack: 105,
                        position: "back",
                        skill: (self, allCharacters) => {
                            const enemies = allCharacters.filter(c => c.owner !== self.owner && c.hp > 0);
                            if (enemies.length > 0) {
                                const target = enemies[Math.floor(Math.random() * enemies.length)];
                                target.charmed = true;
                                target.attackReduction = 0.5;
                                target.originalOwner = target.owner;
                                target.owner = self.owner;
                                return `${self.name} 使用我們都是臭婊，使 ${target.name} 轉為己方，並降低其50%攻擊力！`;
                            }
                            return `${self.name} 使用我們都是臭婊，但沒有目標！`;
                        }
                    }
                ];
            }

            // 保留 banCharacter、pickCharacter、placeCharacter、initializeBattle、executeBattleTurn 等方法...

            getGameState() {
                return {
                    phase: this.currentPhase,
                    turn: this.currentTurn,
                    playerA: {
                        name: this.playerA.name,
                        bannedCharacter: this.playerA.bannedCharacter ? this.playerA.bannedCharacter.name : null,
                        selectedCharacters: this.playerA.selectedCharacters.map(c => ({ 
                            name: c.name, 
                            hp: c.hp, 
                            maxHp: c.maxHp 
                        }))
                    },
                    playerB: {
                        name: this.playerB.name,
                        bannedCharacter: this.playerB.bannedCharacter ? this.playerB.bannedCharacter.name : null,
                        selectedCharacters: this.playerB.selectedCharacters.map(c => ({ 
                            name: c.name, 
                            hp: c.hp,
                            maxHp: c.maxHp
                        }))
                    },
                    battleTurn: this.battleTurn,
                    gameBoard: this.gameBoard.map(row => 
                        row.map(cell => cell ? { 
                            name: cell.name, 
                            owner: cell.owner, 
                            hp: cell.hp,
                            maxHp: cell.maxHp
                        } : null)
                    )
                };
            }

            resetGame() {
                this.playerA.selectedCharacters = [];
                this.playerA.bannedCharacter = null;
                this.playerA.placedCharacters = new Array(8).fill().map(() => new Array(8).fill(null));
                this.playerB.selectedCharacters = [];
                this.playerB.bannedCharacter = null;
                this.playerB.placedCharacters = new Array(8).fill().map(() => new Array(8).fill(null));
                this.currentPhase = "ban";
                this.currentTurn = "playerA";
                this.gameBoard = new Array(8).fill().map(() => new Array(8).fill(null));
                this.battleTurn = 0;
                this.selectedCharacter = null;
                return "遊戲已重置!";
            }
        }

        // 遊戲前端界面
        class GameFrontend {
            constructor() {
                this.game = new Game();
                this.initializeUI();
                this.render();
            }

            initializeUI() {
                this.phaseIndicator = document.getElementById('phaseIndicator');
                this.playerACharacters = document.getElementById('playerA-characters');
                this.playerBCharacters = document.getElementById('playerB-characters');
                this.playerABanned = document.getElementById('playerA-banned');
                this.playerBBanned = document.getElementById('playerB-banned');
                this.characterSelection = document.getElementById('characterSelection');
                this.gameBoard = document.getElementById('gameBoard');
                this.battleLog = document.getElementById('battleLog');
                this.banBtn = document.getElementById('banBtn');
                this.pickBtn = document.getElementById('pickBtn');
                this.placeBtn = document.getElementById('placeBtn');
                this.battleBtn = document.getElementById('battleBtn');
                this.resetBtn = document.getElementById('resetBtn');

                this.setupEventListeners();
                this.renderCharacters();
                this.renderBoard();
            }

            setupEventListeners() {
                this.characterSelection.addEventListener('click', (e) => {
                    const card = e.target.closest('.character-card');
                    if (card) {
                        const id = parseInt(card.dataset.id);
                        const character = this.game.characters.find(c => c.id === id);
                        if (character) {
                            this.game.selectedCharacter = character;
                            this.renderCharacters();
                        }
                    }
                });

                this.gameBoard.addEventListener('click', (e) => {
                    const cell = e.target.closest('.board-cell');
                    if (cell) {
                        const row = parseInt(cell.dataset.row);
                        const col = parseInt(cell.dataset.col);
                        if (this.game.currentPhase === 'placement' && this.game.selectedCharacter) {
                            try {
                                const player = this.game.currentTurn === 'playerA' ? 'playerA' : 'playerB';
                                const index = this.game[player === 'playerA' ? 'playerA' : 'playerB'].selectedCharacters.findIndex(c => c.id === this.game.selectedCharacter.id);
                                const result = this.game.placeCharacter(player, index, row, col);
                                this.battleLog.innerHTML += `<p>${result}</p>`;
                                this.game.selectedCharacter = null;
                                this.render();
                            } catch (error) {
                                this.battleLog.innerHTML += `<p style="color: red;">${error.message}</p>`;
                            }
                        }
                    }
                });

                this.banBtn.addEventListener('click', () => {
                    if (this.game.selectedCharacter) {
                        try {
                            const player = this.game.currentTurn;
                            const result = this.game.banCharacter(player, this.game.selectedCharacter.id);
                            this.battleLog.innerHTML += `<p>${result}</p>`;
                            this.game.selectedCharacter = null;
                            this.render();
                        } catch (error) {
                            this.battleLog.innerHTML += `<p style="color: red;">${error.message}</p>`;
                        }
                    }
                });

                this.pickBtn.addEventListener('click', () => {
                    if (this.game.selectedCharacter) {
                        try {
                            const player = this.game.currentTurn;
                            const result = this.game.pickCharacter(player, this.game.selectedCharacter.id);
                            this.battleLog.innerHTML += `<p>${result}</p>`;
                            this.game.selectedCharacter = null;
                            this.render();
                        } catch (error) {
                            this.battleLog.innerHTML += `<p style="color: red;">${error.message}</p>`;
                        }
                    }
                });

                this.placeBtn.addEventListener('click', () => {
                    if (this.game.selectedCharacter && this.game.currentPhase === 'placement') {
                        const cells = this.gameBoard.querySelectorAll('.board-cell');
                        cells.forEach(cell => {
                            if (cell.classList.contains('highlight')) {
                                const row = parseInt(cell.dataset.row);
                                const col = parseInt(cell.dataset.col);
                                try {
                                    const player = this.game.currentTurn === 'playerA' ? 'playerA' : 'playerB';
                                    const index = this.game[player].selectedCharacters.findIndex(c => c.id === this.game.selectedCharacter.id);
                                    const result = this.game.placeCharacter(player, index, row, col);
                                    this.battleLog.innerHTML += `<p>${result}</p>`;
                                    this.game.selectedCharacter = null;
                                    this.render();
                                } catch (error) {
                                    this.battleLog.innerHTML += `<p style="color: red;">${error.message}</p>`;
                                }
                            }
                        });
                    }
                });

                this.battleBtn.addEventListener('click', () => {
                    if (this.game.currentPhase === 'battle') {
                        const log = this.game.executeBattleTurn();
                        log.forEach(msg => this.battleLog.innerHTML += `<p>${msg}</p>`);
                        this.render();
                    }
                });

                this.resetBtn.addEventListener('click', () => {
                    const result = this.game.resetGame();
                    this.battleLog.innerHTML += `<p>${result}</p>`;
                    this.render();
                });
            }

            renderCharacters() {
                this.characterSelection.innerHTML = '';
                const bannedIds = [
                    this.game.playerA.bannedCharacter?.id,
                    this.game.playerB.bannedCharacter?.id
                ];
                const selectedIds = [
                    ...this.game.playerA.selectedCharacters.map(c => c.id),
                    ...this.game.playerB.selectedCharacters.map(c => c.id)
                ];

                this.game.characters.forEach(character => {
                    if (!bannedIds.includes(character.id) && !selectedIds.includes(character.id)) {
                        const card = document.createElement('div');
                        card.className = 'character-card';
                        card.dataset.id = character.id;
                        if (this.game.selectedCharacter && this.game.selectedCharacter.id === character.id) {
                            card.classList.add('selected');
                        }
                        card.innerHTML = `
                            <div>${character.name} - ${character.title}</div>
                            <div>HP: ${character.hp}, 攻擊: ${character.attack}</div>
                            <div class="status">${this.game.selectedCharacter?.id === character.id ? '已選中' : ''}</div>
                        `;
                        this.characterSelection.appendChild(card);
                    }
                });
            }

            renderBoard() {
                this.gameBoard.innerHTML = '';
                for (let r = 0; r < 8; r++) {
                    for (let c = 0; c < 8; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'board-cell';
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        if (this.game.currentPhase === 'placement' && this.game.selectedCharacter) {
                            cell.classList.add('highlight');
                        }
                        const character = this.game.gameBoard[r][c];
                        if (character) {
                            cell.classList.add(character.owner === 'playerA' ? 'player-a' : 'player-b');
                            cell.innerHTML = `
                                <div class="character-on-board">
                                    <div class="name">${character.name}</div>
                                    <div class="hp">${character.hp}/${character.maxHp}</div>
                                </div>
                            `;
                        }
                        this.gameBoard.appendChild(cell);
                    }
                }
            }

            renderPlayerInfo() {
                this.playerABanned.textContent = `禁用角色: ${this.game.playerA.bannedCharacter?.name || '尚未選擇'}`;
                this.playerBBanned.textContent = `禁用角色: ${this.game.playerB.bannedCharacter?.name || '尚未選擇'}`;
                this.playerACharacters.innerHTML = this.game.playerA.selectedCharacters.map(c => `
                    <div class="mini-character">${c.name} (HP: ${c.hp}/${c.maxHp})</div>
                `).join('');
                this.playerBCharacters.innerHTML = this.game.playerB.selectedCharacters.map(c => `
                    <div class="mini-character">${c.name} (HP: ${c.hp}/${c.maxHp})</div>
                `).join('');
            }

            render() {
                const state = this.game.getGameState();
                this.phaseIndicator.textContent = `遊戲階段: ${state.phase === 'ban' ? '禁用階段' : 
                    state.phase === 'pick' ? '選擇階段' : 
                    state.phase === 'placement' ? '佈置階段' : 
                    state.phase === 'battle' ? '戰鬥階段' : '結束階段'} (${state.turn === 'playerA' ? '玩家A' : state.turn === 'playerB' ? '玩家B' : '雙方'})`;

                this.renderCharacters();
                this.renderBoard();
                this.renderPlayerInfo();

                // 更新按鈕狀態
                this.banBtn.disabled = !(state.phase === 'ban' && state.turn === 'playerA' && this.game.selectedCharacter) || 
                    (state.turn === 'playerB' && this.game.playerA.bannedCharacter);
                this.pickBtn.disabled = !(state.phase === 'pick' && this.game.selectedCharacter) || 
                    bannedIds.includes(this.game.selectedCharacter?.id) || selectedIds.includes(this.game.selectedCharacter?.id);
                this.placeBtn.disabled = !(state.phase === 'placement' && this.game.selectedCharacter);
                this.battleBtn.disabled = state.phase !== 'battle';
            }
        }

        // 啟動遊戲
        const gameFrontend = new GameFrontend();
    </script>
</body>
</html>
